### Source-free Domain Adaptive Human Pose Estimation

#### 摘要（现领域问题+本方法）

我们进一步提出了一个**新的框架，该框架由三个模型组成:源模型、中间模型和目标模型**，从源保护和目标相关的角度探讨了任务。源保护模块在抗噪声的同时更有效地保留了源信息，目标相关模块通过构建新的空间概率空间降低了空间表征的稀疏性，并在此空间基础上提出了针对特定姿态的对比学习和信息最大化。

#### 介绍（细说问题+细说本方法和他方法解决问题+贡献（任务+创新+**性能**））

合成数据集可以生成很多标记数据，但是差异大，不好用，域适应降低差距。

具体来说，在传统的数据处理任务中，源数据可以参与自适应过程，从而专注于减少源和目标之间的域转移。然而，在无源数据分析中，在自适应过程中只能使用预训练的源模型，从而导致源域的灾难性遗忘。

直接应用源预训练模型也会由于域移位而引入噪声。因此，平衡源模型知识的吸收与源模型噪声的抵抗是至关重要的。

每个关键点与其他关键点之间的距离都是基于骨骼长度的，关键点K的数量(例如，人体姿势14个，手部姿势21个)明显小于图像中的像素数量(例如512×512≈0.26M)，这使得它成为一项具有挑战性的任务。

源模型保留源信息，目标模型从目标数据中吸收知识，中间模型与源模型和目标模型相互作用，隐式地减小源和目标之间的域间隙，**从而用于最终的推理**。**在源保护模块中，我们在源模型和中间模型之间进行知识传递，防止源相关信息的灾难性遗忘。**我们将知识从源模型转移到中间模型，同时保持源模型的特征提取器不变。**针对噪声，我们提出了一种新的残差损失，并对源模型的回归量进行了微调。在目标相关模块中，我们在中间模型和目标模型之间执行，以减轻源域和目标域之间的域转移。**我们为HPE构建了一个新的空间概率空间，以缓解稀疏性问题。

#### 结论（贡献的总结版）

pass

#### 本方法

##### 2D HPE的准备

**基于热图的二维HPE过程**。该模型包括两个部分:特征提取器G和回归器F。将输入图像输入到模型中，得到K个关键点对应的K张输出热图。

<img src="C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907090159935.png" alt="image-20230907090159935" style="zoom:150%;" />

Ground truth heatmaps 由一个以 ground truth joint location,为中心的二维高斯图生成的，每个关键点有一个热图。在推理阶段，训练良好的监督模型输出热图，预测每个像素处出现关节的概率。对于每个热图，概率最高的像素被认为是关节的预测位置。

##### 问题情况

源域和目标域共享相同的标签空间，但位于不同的分布中(例如合成与真实)。**训练过程分为两个阶段:预训练阶段和适应阶段**。在预训练阶段，使用标记的源域数据集S来训练源模型f<sup>sr</sup>。然而，无源域自适应HPE与一般域自适应HPE的区别在于自适应阶段，**即只有源模型f<sup>sr</sup>和目标域数据集T可用于训练，源域数据集不能再使用**。我们的目标是开发一个在目标数据集上表现良好的模型。

##### 源模型预训练

该网络由特征提取器G(如ResNet主干)和姿态回归器F组成，因此源模型可以表示为f<sup>sr</sup> = F<sup>sr</sup>(G<sup>sr</sup>(·))。

预训练的总体目标

![image-20230907093016120](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907093016120.png)

其中L<sub>mse</sub>是预测热图表示与真实情况之间的均方误差(MSE)损失。

##### 适应框架

它包括三个模型，每个模型都有一个特征提取器和一个回归器。适应包括步骤A和步骤B两个步骤。步骤A适用于源保护适应，步骤B适用于目标相关适应。**实线箭头表示关联损失的正向更新过程，虚线箭头表示关联损失的反向更新过程**。EMA是指从目标模型到中间模型更新中间模型权重的指数移动平均过程。在开始适应时，f<sup>in</sup>和f<sup>tg</sup>从源模型f<sup>sr</sup>初始化。对于单个适配迭代，执行两个步骤如图2所示。

![image-20230907093447424](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907093447424.png)

在步骤A中，**我们的目标是克服源域上的灾难性遗忘，同时消除由于域漂移而从源模型中产生的噪声。**因此，源模型的特征提取器G<sup>sr</sup>是固定的，以保留源知识，而其回归量F<sup>sr</sup>是不断更新的，以提高回归精度，从而降低输出中的噪声。相反，中间模型的回归量F<sup>in</sup>是固定的，但其特征提取器G<sup>in</sup>不断更新。**这是因为我们希望特征提取器在表示级别上学习更多的源知识，而源模型中由于域移位而产生的噪声可以被抑制。**

在步骤B中，我们的目标是在中间模型和目标模型之间以目标相关的方式进行自适应。在此过程中，使用了几种特定姿势的技术来最小化这两个模型之间的差异。**虽然f<sup>in</sup>和f<sup>tg</sup>都在这一步更新，但f<sup>tg</sup>是通过反向传播更新的，而f<sup>in</sup>是通过f<sup>tg</sup>的EMA更新的**，因为在训练步骤上平均模型权值往往比直接使用最终权值产生更准确的模型。

##### 源保护模块（基于向量的）

这里我们选择源模型和中间模型在同一位置生成的两张热图进行说明。为简单起见，这里将热图的比例尺设置为3 × 3，而实际尺寸为64 × 64。残余损失如下：

![image-20230907101646661](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907101646661.png)

首先，我们引入在源模型上校准的微调损失:

![image-20230907101018476](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907101018476.png)

回归器正在更新:

![image-20230907101115010](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907101115010.png)

式中，θ<sup>s</sup><sub>F</sub>为源模型回归量F<sup>s</sup>的权值,t为训练步长，λ<sup> s</sup>为源模型的学习率。

方程2的应用促进了源模型和中间模型之间的相互知识转移。**除了热图中置信度最高的像素外，其他像素还包含有利于知识转移的有价值信息，这就是我们在图3中提出残差损失的原因。**

从图中的示例中，移除源热图中最自信的像素(置信度= 1.0)，同时移除红色标记的中间热图中相同位置置信度为0.8的像素。用蓝色标记的配对遵循相同的规则，但基于中间热图。

然后建立自适应残差热图，分别记为h<sup>^sr</sup><sub>i,j</sub>和h<sup>^in</sup><sub>i,j</sub>。此外，我们利用KL散度保证了h<sup>^in</sup><sub>i,j</sub>接近h<sup>^sr</sup><sub>i,j</sub>，从而保留了源信息。基于这些，我们可以推导出剩余损失为:

![image-20230907102422954](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907102422954.png)

其中D<sub>KL</sub>为KL散度，σ(·)为softmax函数。此外，τ是用于缩放残差热图的温度，经验设置为0.3。结合微调损失和残差损失，得到更新中间模型的优化过程和目标函数:

![image-20230907102621409](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907102621409.png)

其中t是训练步长，λ<sup>in</sup>是G<sup>in</sup>的学习率。此外，α是这两种损失之间的权衡超参数。

##### Target-relevant Modules

热图投影的图示:为了降低热图的稀疏性，我们将热图投影成一个水平向量和一个垂直向量。为简单起见，这里将热图的比例尺设置为4×4，将矢量的比例尺设置为4×1，而实际热图的大小为64 × 64，矢量的大小为64 ×1。

![image-20230907152914800](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907152914800.png)

我们从水平和垂直两个方向引入热图的投影。对于中间模型从第i个样本的第j个关键点生成的热图h<sup>in</sup><sub>i,j</sub>，其投影可以表示为proj(h<sup>in</sup><sub>i,j</sub>) = (v<sup>in</sup><sub>i,jx</sub>, v<sup>in</sup><sub>i,jy</sub>)，其中v<sup>in</sup><sub>i,jx</sub>为水平向量，v<sup>in</sup><sub>i,jy</sub>为垂直向量。这个矢量对是我们提出的以下模块和损失的基础。

首先，我们提出了中间模型和目标模型之间的特定姿势对比损失。根据[12]的观察，错误的预测通常位于其他关键点的位置。**在这种情况下，改进回归可以通过最小化同一位置的热图差异和最大化不同位置的热图差异来实现。**这就是我们在图5中定义正负对的方法。

![image-20230907154659669](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907154659669.png)

 将中间模型和目标模型生成的两张热图的相似度分别表示为:

![image-20230907154600297](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907154600297.png)

在相似度的基础上，我们将整体的特定姿势对比损失定义为:

![image-20230907154853772](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907154853772.png)

接下来，我们提出了一种姿态特定的自我监督技术，称为姿态特定信息最大化。信息最大化对无源领域自适应分类非常有帮助[21]，因为它使目标输出个体确定性和全局多样性，从而隐式地减轻了领域差距。然而，由于热图的稀疏性，改进是有限的。在投影向量的帮助下，我们将信息最大化损失细化为:

![image-20230907155458644](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907155458644.png)

![image-20230907155539430](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907155539430.png)

这里L<sub>entx</sub>是水平向量的熵，L<sub>enty</sub>是垂直向量的熵。公式8中的最后一项是促进多样性的目标。此外，我们引入了两个模型输出之间的一致性损失:

![image-20230907155728397](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907155728397.png)

综上所述，我们可以得出目标模型的总体目标损失函数为:

![image-20230907155830507](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907155830507.png)

其中β和γ是权衡参数。

此外，在这一步中，中间模型通过指数移动平均策略(EMA)进行更新:

![image-20230907155906540](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907155906540.png)

其中t表示训练步长，η表示平滑系数默认设置为0.999。

注释：**热图**中颜色渐变的根据通常是根据像素点的数值大小来确定的。在计算机视觉中，热图通常用于表示一些连续的数值分布，例如像素点的梯度、深度、置信度等。通常情况下，数值越大的像素点，对应的颜色就越深，数值越小的像素点，对应的颜色就越浅，从而形成一种颜色渐变的效果。

**正向更新**：对于每个真实框（ground truth），计算其与所有锚框（anchor）的相关系数，得到一个相关系数矩阵。将相关系数矩阵作为模型的输出，与真实标签进行比较，计算损失值。根据损失值更新模型参数。
**反向更新**：计算损失函数对模型参数的梯度。根据梯度下降算法，对模型参数进行反向更新。

#### 实验

**数据集。**我们使用三个人体姿势数据集和三个手部姿势数据集来验证我们的方法。SURREAL[36]作为**源人体姿势数据集**，包含600万张合成人体姿势图像。Human3.6M[11]是**目标人体姿态数据集**之一，由360万张图像组成，分布在7个折叠中。根据前人的研究[12,16]，将S1、S5、S6、S7、S8指定为训练集，将S9、S11指定为测试集。另一个目标数据集是Leeds Sports Pose [15] (LSP)，这是一个包含2000张图像的真实数据集，我们使用所有这些图像进行自适应。我们专注于两个领域适应任务:SURREAL → Human3.6M and SURREAL → LSP for human pose tasks.

Rendered Hand Pose Dataset 是具有43986张合成手图像的源手数据集，其中41258张用于训练，其余2728张用于验证。

Hand-3D-Studio (H3D)是两个目标手数据集之一，包括22,000个真实世界的帧。对于训练，我们使用了18,800帧，并保留其余的用于测试，遵循先前研究论文[12,16]中概述的方案。

另一个目标手数据集FreiHand[43]提供了130k张真实世界的图像，我们将它们全部用于我们的自适应任务。

**实现细节。**我们采用Simple Baseline[39]和ResNet-101[9]作为HPE骨干网，遵循之前的工作[12,16]。在预训练过程中，我们使用Adam[17]优化器进行了40个epoch，每个epoch有500次迭代，初始学习率为1e<sup>-4</sup>。学习率在25次时降至1e<sup>-5</sup>。对于适应过程，我们执行了40个epoch和30,000次迭代。在步骤A中，我们选择F<sup>sr</sup>的初始学习率为1e<sup>-4</sup>, G<sup>in</sup>的初始学习率为1e<sup>5</sup>。步骤B设置G<sup>tg</sup>的初始学习率为1e<sup>-4</sup>, F<sup>tg</sup>的初始学习率为1e<sup>-3</sup>。我们对学习率调度器使用了与[12]中相同的退火策略。对于超参数，我们选择α = 0.7， β = 0.5， γ = 0.85。并利用中间模型进行最终推理。

##### 结果

![image-20230907172237838](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907172237838.png)

![image-20230907172253905](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907172253905.png)

![image-20230907172310526](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907172310526.png)

![image-20230907172332903](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907172332903.png)

![image-20230907173136747](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907173136747.png)

表一和表二是手部任务。表三和表四是人体任务。

为了评估所提出方法的准确性，我们采用了先前工作中使用的正确关键点百分比(PCK)度量。我们将正确预测的比率设置为5%，并在表1-4中报告PCK@0.05。

除了整体关键点精度外，我们还将关节划分为几个部分段，并使用特定指标衡量其性能。对于21个关键点的手部骨骼，我们使用掌指关节(MCP)、近端指间关节(PIP)、远端指间关节(DIP)和指尖(Fin)指标。对于18个关键点的人体骨骼，我们选择肩膀(Sld)，肘部(Elb)，手腕，臀部，膝盖和脚踝指标。这些特定于细分市场的指标可以对模型的性能进行更详细的评估。

#### 消融实验

**结构**

源保护模块(SP)和目标相关模块(TR)，这里我们重点讨论它们的功能。此外，我们使用MMT[6]作为基线

![image-20230907173421236](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907173421236.png)

**损失**

我们在基线中保留了源保护模块中的Lf t和目标相关模块中的Lcon。

![image-20230907173625573](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907173625573.png)

我们比较了基于热图的方法和基于向量的方法的两种损失函数:对比学习(L<sub>cst</sub>)和信息最大化(L<sub>im</sub>)。我们将基于热图的对比学习和信息最大化分别表示为HBCL和HBIM，将基于向量的对比学习和信息最大化分别表示为VBCL和VBIM。

![image-20230907173934798](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907173934798.png)

##### 参数分析

RHD→H3D参数分析(彩色效果最佳)。a:对α的分析。b: β分析。c: γ分析

![image-20230907184718023](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907184718023.png)

由此可知，α = 0.7， β = 0.5， γ = 0.85是最佳选择。

![image-20230907185049776](C:\Users\lxc\AppData\Roaming\Typora\typora-user-images\image-20230907185049776.png)

如图8所示，结果证明了模型对未知数据集的有效泛化能力，这意味着自适应过程提高了模型的泛化能力，超出了原始训练数据集。

补充：**退火策略（Simulated Annealing）**是一种优化算法，常用于在大规模搜索空间中找到全局最优解。**其基本思想是在搜索过程中逐渐减小温度，从而使算法在早期能够接受较差的解，避免陷入局部最优解**。

具体而言，退火策略包括以下步骤：

（1）初始化温度T和初始解x；
（2）在每个温度下进行迭代，每次迭代时随机生成一个新解x'；
（3）计算新解的目标函数值f(x')和当前解的目标函数值f(x)；
（4）如果f(x') < f(x)，则接受新解x'；
（5）如果f(x') > f(x)，则以一定概率接受新解，概率由Metropolis准则决定；
（6）降低温度T；
重复步骤2-6，直到满足终止条件。
其中，Metropolis准则指出，如果新解比当前解更劣，则以概率exp(-(f(x')-f(x))/T)接受新解。这个概率会随着温度的降低而逐渐减小，从而使算法在后期更加趋向于接受更优的解。

**PCK度量**是通过计算预测关键点与真实关键点之间的距离是否小于一定阈值来衡量模型的准确度，即正确预测的关键点数量除以总关键点数量。具体来说，将正确预测的比率设置为5%意味着只有当预测关键点与真实关键点之间的距离小于图像尺寸的5%时，才将其视为正确预测。这样做的好处是可以减少模型对于噪声、遮挡等因素的敏感度，从而更好地评估模型在实际场景中的表现。